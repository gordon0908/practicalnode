/*! hello 02-06-2015*/
var mongoose=require("mongoose"),articleSchema=mongoose.Schema({title:{type:String,require:!0,valide:[function(a){return a.length<=120},"title is too long 120 max"],"default":"New Post"},text:String,published:{type:Boolean,"default":!1},slug:{type:String,set:function(a){return a.toLowerCase().replace(" ","-")}}});articleSchema["static"]({list:function(a){this.find({},null,{sort:{_id:-1}},a)}}),module.exports=mongoose.model("Article",articleSchema),exports.Article=require("./article"),exports.User=require("./user");var mongoose=require("mongoose"),userSchema=mongoose.Schema({email:{type:String,required:!0,set:function(a){return a.trim().toLowerCase()}},password:String,admin:{type:Boolean,"default":!1}});module.exports=mongoose.model("User",userSchema),exports.show=function(a,b,c){return a.params.slug?void a.models.Article.findOne({slug:a.params.slug},function(a,d){return a?c(a):d.published?void b.render("article",d):b.send(401)}):c(new Error("no article slug"))},exports.list=function(a,b,c){a.models.Article.list(function(a,d){return a?c(a):void b.send({articles:d})})},exports.add=function(a,b,c){if(!a.body.article)return c(new Error("no article data"));var d=a.body.article;d.published=!1,a.models.Article.create(d,function(a,d){return a?c(a):void b.send(d)})},exports.edit=function(a,b,c){return a.params.id?void a.models.Article.findByIdAndUpdate(a.params.id,{$set:a.body.article},function(a,d){return a?c(a):void b.send({affectedCount:d})}):c(new Error("no article id"))},exports.del=function(a,b,c){return a.params.id?void a.models.Article.findByIdAndRemove(a.params.id,function(a,d){return a?c(a):void b.send({affectedCount:d})}):c(new Error("no article id"))},exports.post=function(a,b,c){a.body.title||b.render("post")},exports.postArticle=function(a,b,c){if(!a.body.title||!a.body.slug||!a.body.text)return b.render("post",{error:"fill title, slug and text"});var d={title:a.body.title,slug:a.body.slug,text:a.body.text,published:!1};a.models.Article.create(d,function(a,d){return a?c(a):void b.render("post",{error:"Article was added. Publish it on Admin page."})})},exports.admin=function(a,b,c){a.models.Article.list(function(a,d){return a?c(a):void b.render("admin",{articles:d})})},exports.article=require("./article"),exports.user=require("./user"),exports.index=function(a,b,c){a.models.Article.list(function(a,d){return a?c(a):void b.render("index",{articles:d})})},exports.list=function(a,b){b.send("respond with resource")},exports.login=function(a,b,c){b.render("login")},exports.logout=function(a,b,c){a.session.destroy(),b.redirect("/")},exports.authenricate=function(a,b,c){return""==a.body.email||""==a.body.password?b.render("login",{error:"please enter your email and pswd"}):void a.models.User.findOne({email:a.body.email,password:a.body.password},function(c,d){return c||!d?b.render("login",{error:"failed login"}):(a.session.user=d,a.session.admin=d.admin,void b.redirect("/admin"))})};